# Use Brotli-enabled Nginx image
FROM fholzer/nginx-brotli:latest

# Install OpenSSL (for dhparam.pem generation & SSL utils)
RUN apk add --no-cache openssl

# Remove default Nginx configs
RUN rm -rf /etc/nginx/conf.d/*

# Create required directories
RUN mkdir -p /var/cache/nginx/proxy \
    /var/cache/nginx/fastcgi \
    /var/log/nginx \
    /var/www/certbot \
    /etc/nginx/ssl

# Copy custom Nginx configuration
COPY nginx.conf /etc/nginx/nginx.conf

# Copy self-signed SSL certs for local/dev
COPY ssl/ /etc/nginx/ssl/

# Generate strong Diffie-Hellman group
RUN openssl dhparam -out /etc/nginx/ssl/dhparam.pem 2048

# Set permissions (ensure Nginx has access)
RUN chown -R nginx:nginx /var/cache/nginx /var/log/nginx /var/www/certbot /etc/nginx/ssl && \
    chmod -R 755 /var/www/certbot

# Expose ports for HTTP & HTTPS
EXPOSE 80 443

# Start Nginx in foreground
CMD ["-g", "daemon off;"]
